const fs = require("fs");
const path = require("path");

module.exports = async function run({ github, context }) {
  const owner = context.repo.owner;
  const repo = context.repo.repo;

  function severityCounts(alerts) {
    return alerts.reduce(
      (acc, a) => {
        const s = (a.security_advisory?.severity || "unknown").toLowerCase();
        acc[s] = (acc[s] || 0) + 1;
        return acc;
      },
      { critical: 0, high: 0, medium: 0, low: 0, unknown: 0 }
    );
  }

  const alerts = await github.paginate(github.rest.dependabot.listAlertsForRepo, {
    owner,
    repo,
    per_page: 100,
    state: "open",
  });
  // Emit a CSV snapshot locally.
  const outputPath = process.env.DEPENDABOT_CSV_PATH || "dependabot-report.csv";
  const absolutePath = path.resolve(outputPath);

  const csvEscape = (value) => {
    const v = value == null ? "" : String(value);
    return /[",\n]/.test(v) ? `"${v.replace(/"/g, '""')}"` : v;
  };
  const csvHeader = "package,severity,vulnerable_range,patched_version,issue_url";
  const csvRows = alerts.map((a) => {
    const pkg = a.dependency?.package?.name || "n/a";
    const severity = (a.security_advisory?.severity || "unknown").toLowerCase();
    const range = a.security_vulnerability?.vulnerable_version_range || "n/a";
    const patched = a.security_vulnerability?.first_patched_version?.identifier || "none";
    const issueUrl = a.html_url || "n/a";
    return [
      pkg,
      severity,
      range,
      patched,
      issueUrl
    ]
      .map(csvEscape)
      .join(",");
  });
  fs.writeFileSync(absolutePath, [csvHeader, ...csvRows].join("\n"), "utf8");
  console.log(`CSV written to ${absolutePath}`);

  // Optional email summary with attachment; falls back to preview if SMTP not configured.
  const counts = severityCounts(alerts);
  const updatedAt = new Date().toISOString();
  const subject = `Dependabot snapshot: ${alerts.length} open alerts (${owner}/${repo})`;
  const lines = [
    subject,
    `Generated: ${updatedAt}`,
    `By severity: critical ${counts.critical} 路 high ${counts.high} 路 medium ${counts.medium} 路 low ${counts.low} 路 unknown ${counts.unknown}`,
    `CSV: ${absolutePath}`,
  ];

  const {
    SMTP_HOST,
    SMTP_PORT = "587",
    SMTP_USER,
    SMTP_PASS,
    EMAIL_FROM,
    EMAIL_TO,
  } = process.env;

  if (SMTP_HOST && SMTP_USER && SMTP_PASS && EMAIL_FROM && EMAIL_TO) {
    let nodemailer;
    try {
      nodemailer = require("nodemailer");
    } catch (err) {
      console.warn("nodemailer not installed; printing email preview instead");
    }
    if (nodemailer) {
      const transporter = nodemailer.createTransport({
        host: SMTP_HOST,
        port: Number(SMTP_PORT),
        secure: Number(SMTP_PORT) === 465,
        auth: { user: SMTP_USER, pass: SMTP_PASS },
      });
      try {
        await transporter.sendMail({
          from: EMAIL_FROM,
          to: EMAIL_TO,
          subject,
          text: lines.join("\n"),
          attachments: [
            {
              filename: path.basename(absolutePath),
              path: absolutePath,
            },
          ],
        });
        console.log(`Email sent to ${EMAIL_TO}`);
        return;
      } catch (err) {
        console.warn("Email send failed; printing preview. Error:", err.message);
      }
    }
  }

  console.log(["[Email preview]", ...lines].join("\n"));
};
