const fs = require("fs");
const path = require("path");

module.exports = async function run({ github, context }) {
  const owner = context.repo.owner;
  const repo = context.repo.repo;

  function severityCounts(alerts) {
    return alerts.reduce(
      (acc, a) => {
        const s = (a.security_advisory?.severity || "unknown").toLowerCase();
        acc[s] = (acc[s] || 0) + 1;
        return acc;
      },
      { critical: 0, high: 0, medium: 0, low: 0, unknown: 0 }
    );
  }

  const alerts = await github.paginate(github.rest.dependabot.listAlertsForRepo, {
    owner,
    repo,
    per_page: 100,
    state: "open",
  });
  // Emit a CSV snapshot locally.
  const outputPath = process.env.DEPENDABOT_CSV_PATH || "dependabot-report.csv";
  const absolutePath = path.resolve(outputPath);

  const csvEscape = (value) => {
    const v = value == null ? "" : String(value);
    return /[",\n]/.test(v) ? `"${v.replace(/"/g, '""')}"` : v;
  };
  const csvHeader = "package,severity,vulnerable_range,patched_version,issue_url";
  const csvRows = alerts.map((a) => {
    const pkg = a.dependency?.package?.name || "n/a";
    const severity = (a.security_advisory?.severity || "unknown").toLowerCase();
    const range = a.security_vulnerability?.vulnerable_version_range || "n/a";
    const patched = a.security_vulnerability?.first_patched_version?.identifier || "none";
    const issueUrl = a.html_url || "n/a";
    return [
      pkg,
      severity,
      range,
      patched,
      issueUrl
    ]
      .map(csvEscape)
      .join(",");
  });
  fs.writeFileSync(absolutePath, [csvHeader, ...csvRows].join("\n"), "utf8");
  console.log(`CSV written to ${absolutePath}`);

  // Optional email summary with attachment; falls back to preview if SMTP not configured.
  const counts = severityCounts(alerts);
  const updatedAt = new Date().toISOString();
  const subject = `Dependabot snapshot: ${alerts.length} open alerts (${owner}/${repo})`;
  const textTableHeader = "package | severity | vulnerable_range | patched_version | issue_url";
  const textTable = [
    textTableHeader,
    "-".repeat(textTableHeader.length),
    ...alerts.map((a) => {
      const pkg = a.dependency?.package?.name || "n/a";
      const severity = (a.security_advisory?.severity || "unknown").toLowerCase();
      const range = a.security_vulnerability?.vulnerable_version_range || "n/a";
      const patched = a.security_vulnerability?.first_patched_version?.identifier || "none";
      const issueUrl = a.html_url || "n/a";
      return `${pkg} | ${severity} | ${range} | ${patched} | ${issueUrl}`;
    }),
  ].join("\n");

  const htmlRows = alerts
    .map((a) => {
      const pkg = a.dependency?.package?.name || "n/a";
      const severity = (a.security_advisory?.severity || "unknown").toLowerCase();
      const range = a.security_vulnerability?.vulnerable_version_range || "n/a";
      const patched = a.security_vulnerability?.first_patched_version?.identifier || "none";
      const issueUrl = a.html_url || "";
      const link = issueUrl ? `<a href="${issueUrl}">link</a>` : "n/a";
      return `<tr><td>${pkg}</td><td>${severity}</td><td>${range}</td><td>${patched}</td><td>${link}</td></tr>`;
    })
    .join("");

  const htmlBody = `
    <p><strong>${subject}</strong></p>
    <p>Generated: ${updatedAt}</p>
    <p>By severity: critical ${counts.critical} · high ${counts.high} · medium ${counts.medium} · low ${counts.low} · unknown ${counts.unknown}</p>
    <p>CSV path (artifact/local): ${absolutePath}</p>
    <table border="1" cellpadding="4" cellspacing="0">
      <thead>
        <tr>
          <th>package</th>
          <th>severity</th>
          <th>vulnerable_range</th>
          <th>patched_version</th>
          <th>issue_url</th>
        </tr>
      </thead>
      <tbody>
        ${htmlRows}
      </tbody>
    </table>
  `;

  const textBody = [
    subject,
    `Generated: ${updatedAt}`,
    `By severity: critical ${counts.critical} · high ${counts.high} · medium ${counts.medium} · low ${counts.low} · unknown ${counts.unknown}`,
    `CSV: ${absolutePath}`,
    "",
    textTable,
  ];

  const {
    SMTP_HOST,
    SMTP_PORT = "587",
    SMTP_USER,
    SMTP_PASS,
    EMAIL_FROM,
    EMAIL_TO,
  } = process.env;

  if (SMTP_HOST && SMTP_USER && SMTP_PASS && EMAIL_FROM && EMAIL_TO) {
    let nodemailer;
    try {
      nodemailer = require("nodemailer");
    } catch (err) {
      console.warn("nodemailer not installed; printing email preview instead");
    }
    if (nodemailer) {
      const transporter = nodemailer.createTransport({
        host: SMTP_HOST,
        port: Number(SMTP_PORT),
        secure: Number(SMTP_PORT) === 465,
        auth: { user: SMTP_USER, pass: SMTP_PASS },
      });
      try {
        await transporter.sendMail({
          from: EMAIL_FROM,
          to: EMAIL_TO,
          subject,
          text: textBody.join("\n"),
          html: htmlBody,
          attachments: [
            {
              filename: path.basename(absolutePath),
              path: absolutePath,
            },
          ],
        });
        console.log(`Email sent to ${EMAIL_TO}`);
        return;
      } catch (err) {
        console.warn("Email send failed; printing preview. Error:", err.message);
      }
    }
  }

  console.log(["[Email preview]", ...lines].join("\n"));
};
