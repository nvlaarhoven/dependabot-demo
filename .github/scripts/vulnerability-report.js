const nodemailer = require("nodemailer");
const buildEmail = require("./vulnerability-report-email");

module.exports = async function run({ github, context }) {
  const owner = context.repo.owner;
  const repo = context.repo.repo;

  function severityCounts(alerts) {
    return alerts.reduce(
      (acc, a) => {
        const s = (a.security_advisory?.severity || "unknown").toLowerCase();
        acc[s] = (acc[s] || 0) + 1;
        return acc;
      },
      { critical: 0, high: 0, medium: 0, low: 0, unknown: 0 }
    );
  }

  const alerts = await github.paginate(
    github.rest.dependabot.listAlertsForRepo,
    {
      owner,
      repo,
      per_page: 100,
      state: "open",
    }
  );

  const counts = severityCounts(alerts);
  const updatedAt = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
  const subject = `Dependabot snapshot: ${alerts.length} open alerts (${owner}/${repo})`;
  const { text, html } = buildEmail({ subject, counts, updatedAt, alerts });

  const { SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, EMAIL_FROM, EMAIL_TO } =
    process.env;

  const port = Number(SMTP_PORT || 587);
  const transporter = nodemailer.createTransport({
    host: SMTP_HOST,
    port,
    auth: { user: SMTP_USER, pass: SMTP_PASS },
  });
  try {
    await transporter.sendMail({
      from: EMAIL_FROM,
      to: EMAIL_TO,
      subject,
      text,
      html,
    });
    console.log(`Email sent to ${EMAIL_TO}`);
    return;
  } catch (err) {
    console.warn("Email send failed; printing preview. Error:", err.message);
  }
};
