/**
 * Build text and HTML email bodies for the Dependabot snapshot.
 * @param {Object} params
 * @param {string} params.subject
 * @param {Object} params.counts
 * @param {string} params.updatedAt ISO timestamp
 * @param {Array} params.alerts Dependabot alert objects
 * @returns {{text: string, html: string}}
 */
module.exports = function buildEmail({ subject, counts, updatedAt, alerts }) {
  const rows = alerts.map((a) => ({
    pkg: a.dependency?.package?.name || "n/a",
    severity: (a.security_advisory?.severity || "unknown").toLowerCase(),
    range: a.security_vulnerability?.vulnerable_version_range || "n/a",
    patched: a.security_vulnerability?.first_patched_version?.identifier || "none",
    issueUrl: a.html_url || "",
  }));

  const textTableHeader =
    "package | severity | vulnerable_range | patched_version | issue_url";
  const textTable = [
    textTableHeader,
    "-".repeat(textTableHeader.length),
    ...rows.map((r) => {
      const issue = r.issueUrl || "n/a";
      return `${r.pkg} | ${r.severity} | ${r.range} | ${r.patched} | ${issue}`;
    }),
  ].join("\n");

  const htmlRows = rows
    .map((r) => {
      const link = r.issueUrl ? `<a href="${r.issueUrl}">${r.issueUrl}</a>` : "n/a";
      return `<tr><td>${r.pkg}</td><td>${r.severity}</td><td>${r.range}</td><td>${r.patched}</td><td>${link}</td></tr>`;
    })
    .join("");

  const html = `
    <p><strong>${subject}</strong></p>
    <p>Generated: ${updatedAt}</p>
    <p>By severity: critical ${counts.critical} · high ${counts.high} · medium ${counts.medium} · low ${counts.low} · unknown ${counts.unknown}</p>
    <table border="1" cellpadding="4" cellspacing="0">
      <thead>
        <tr>
          <th>package</th>
          <th>severity</th>
          <th>vulnerable_range</th>
          <th>patched_version</th>
          <th>issue_url</th>
        </tr>
      </thead>
      <tbody>
        ${htmlRows}
      </tbody>
    </table>
  `;

  const text = [
    subject,
    `Generated: ${updatedAt}`,
    `By severity: critical ${counts.critical} · high ${counts.high} · medium ${counts.medium} · low ${counts.low} · unknown ${counts.unknown}`,
    "",
    textTable,
  ].join("\n");

  return { text, html };
};
